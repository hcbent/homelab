---
- name: Configure Elasticsearch keystore with AWS S3 credentials
  hosts: elasticsearch_all
  become: yes
  gather_facts: no
  vars:
    # Define S3 credentials - these should be provided via ansible-vault or command line
    aws_access_key_id: "{{ s3_access_key_id | default('') }}"
    aws_secret_access_key: "{{ s3_secret_access_key | default('') }}"
    s3_endpoint: "{{ s3_endpoint | default('') }}"

  tasks:
    - name: Verify AWS S3 credentials are provided
      fail:
        msg: "AWS S3 credentials must be provided. Use -e s3_access_key_id=YOUR_KEY -e s3_secret_access_key=YOUR_SECRET"
      when: aws_access_key_id == '' or aws_secret_access_key == ''

    - name: Add AWS access key to Elasticsearch keystore
      shell: |
        echo "{{ aws_access_key_id }}" | /usr/share/elasticsearch/bin/elasticsearch-keystore add --stdin --force s3.client.default.access_key
      environment:
        ES_PATH_CONF: /etc/elasticsearch

    - name: Add AWS secret key to Elasticsearch keystore
      shell: |
        echo "{{ aws_secret_access_key }}" | /usr/share/elasticsearch/bin/elasticsearch-keystore add --stdin --force s3.client.default.secret_key
      environment:
        ES_PATH_CONF: /etc/elasticsearch

    - name: Add S3 endpoint to keystore (if provided)
      shell: |
        echo "{{ s3_endpoint }}" | /usr/share/elasticsearch/bin/elasticsearch-keystore add --stdin --force s3.client.default.endpoint
      when: s3_endpoint != ''
      environment:
        ES_PATH_CONF: /etc/elasticsearch

    - name: Set proper ownership of keystore file
      file:
        path: /etc/elasticsearch/elasticsearch.keystore
        owner: elasticsearch
        group: elasticsearch
        mode: '0660'