---
- name: Deploy Pi-hole with Docker
  become: true
  hosts: pihole

  vars:
    pihole_webpassword: "***REMOVED***"
    pihole_dns1: "1.1.1.1"
    pihole_dns2: "8.8.8.8"
    pihole_timezone: "America/New_York"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - docker.io
        - docker-compose
        - containerd

    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Stop and disable systemd-resolved to free port 53
      systemd:
        name: systemd-resolved
        state: stopped
        enabled: no

    - name: Configure manual DNS resolution
      copy:
        dest: /etc/resolv.conf
        content: |
          nameserver {{ pihole_dns1 }}
          nameserver {{ pihole_dns2 }}

    - name: Create Pi-hole data directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      with_items:
        - /opt/pihole
        - /opt/pihole/etc-pihole
        - /opt/pihole/etc-dnsmasq.d

    - name: Stop any existing Pi-hole container
      docker_container:
        name: pihole
        state: absent
      ignore_errors: yes

    - name: Deploy Pi-hole container
      docker_container:
        name: pihole
        image: pihole/pihole:latest
        restart_policy: unless-stopped
        network_mode: host
        env:
          TZ: "{{ pihole_timezone }}"
          WEBPASSWORD: "{{ pihole_webpassword }}"
          PIHOLE_DNS_: "{{ pihole_dns1 }};{{ pihole_dns2 }}"
          DNSMASQ_LISTENING: "all"
          INTERFACE: "{{ ansible_default_ipv4.interface }}"
        volumes:
          - "/opt/pihole/etc-pihole:/etc/pihole"
          - "/opt/pihole/etc-dnsmasq.d:/etc/dnsmasq.d"
        capabilities:
          - NET_ADMIN

    - name: Wait for Pi-hole to be ready
      wait_for:
        port: 80
        host: "{{ ansible_default_ipv4.address }}"
        delay: 10
        timeout: 60

    - name: Wait for DNS service to be ready
      wait_for:
        port: 53
        host: "{{ ansible_default_ipv4.address }}"
        delay: 5
        timeout: 30

    - name: Test DNS resolution
      shell: dig @{{ ansible_default_ipv4.address }} google.com
      register: dns_test
      ignore_errors: yes

    - name: Display Pi-hole access information
      debug:
        msg:
          - "Pi-hole web interface: http://{{ ansible_default_ipv4.address }}/admin"
          - "Password: {{ pihole_webpassword }}"
          - "DNS server: {{ ansible_default_ipv4.address }}:53"
          - "Container status: {{ ansible_facts.get('docker_containers', {}).get('pihole', {}).get('State', {}).get('Status', 'unknown') if ansible_facts.get('docker_containers') else 'running' }}"
          - "DNS test result: {{ 'PASSED' if dns_test.rc == 0 else 'FAILED' }}"