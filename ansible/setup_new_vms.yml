---
- name: Setup newly deployed VMs from Terraform
  hosts: new_vms
  become: yes
  gather_facts: yes
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    ansible_host_key_checking: false
    ansible_ssh_user: "{{ vm_user | default('ubuntu') }}"

  tasks:
    - name: Wait for SSH to be available
      wait_for_connection:
        connect_timeout: 30
        sleep: 5
        delay: 10
        timeout: 600

    - name: Gather system facts
      setup:

    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == "Debian"

    - name: Install essential packages
      apt:
        name:
          - qemu-guest-agent
          - curl
          - wget
          - vim
          - htop
          - net-tools
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Enable and start QEMU Guest Agent
      systemd:
        name: qemu-guest-agent
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Set timezone
      timezone:
        name: "{{ vm_timezone | default('America/New_York') }}"

    - name: Configure automatic security updates
      apt:
        name: unattended-upgrades
        state: present
      when: ansible_facts['os_family'] == "Debian"

    - name: Configure unattended upgrades
      template:
        src: 50unattended-upgrades.j2
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        backup: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Verify QEMU Guest Agent is running
      systemd:
        name: qemu-guest-agent
      register: qemu_status

    - name: Display setup completion status
      debug:
        msg:
          - "VM {{ inventory_hostname }} setup complete!"
          - "QEMU Guest Agent: {{ qemu_status.status.ActiveState }}"
          - "OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
          - "Kernel: {{ ansible_facts['kernel'] }}"