---
- name: Install and configure Fleet Server
  hosts: fleet
  become: yes
  gather_facts: yes

  tasks:
    - name: Download and install Elasticsearch GPG key
      shell: wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
      args:
        creates: /usr/share/keyrings/elasticsearch-keyring.gpg

    - name: Install apt-transport-https
      apt:
        name: apt-transport-https
        state: present
        update_cache: yes

    - name: Add Elasticsearch repository
      lineinfile:
        path: /etc/apt/sources.list.d/elastic-9.x.list
        line: "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/9.x/apt stable main"
        create: yes
        owner: root
        group: root
        mode: '0644'

    - name: Update package cache and install Elastic Agent
      apt:
        name: "elastic-agent={{ fleet_agent_version }}"
        state: present
        update_cache: yes

    - name: Create elastic-agent data directory
      file:
        path: /opt/Elastic/Agent/data
        state: directory
        owner: root
        group: root
        mode: '0755'
        recurse: yes

    - name: Create elastic-agent log directory
      file:
        path: /var/log/elastic-agent
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Install Fleet Server
      shell: |
        elastic-agent install \
          --fleet-server-es={{ elasticsearch_hosts | join(',') }} \
          --fleet-server-service-token={{ fleet_service_token }} \
          --fleet-server-policy={{ fleet_server_policy_id }} \
          --fleet-server-host={{ fleet_server_host }} \
          --fleet-server-port={{ fleet_server_port }} \
          --non-interactive \
          --force
      args:
        creates: /opt/Elastic/Agent/data/elastic-agent.lock
      when:
        - elasticsearch_hosts is defined
        - fleet_service_token is defined
        - fleet_server_policy_id is defined

    - name: Enable and start Elastic Agent service
      systemd:
        name: elastic-agent
        state: started
        enabled: yes

  handlers:
    - name: restart fleet-server
      systemd:
        name: elastic-agent
        state: restarted
        enabled: yes