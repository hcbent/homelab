---
- name: Install Elasticsearch on all nodes
  hosts: elasticsearch_all
  become: yes
  gather_facts: no

  tasks:
    - name: Download and install Elasticsearch GPG key
      shell: wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
      args:
        creates: /usr/share/keyrings/elasticsearch-keyring.gpg

    - name: Install apt-transport-https
      apt:
        name: apt-transport-https
        state: present
        update_cache: yes

    - name: Add Elasticsearch repository
      lineinfile:
        path: /etc/apt/sources.list.d/elastic-9.x.list
        line: "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/9.x/apt stable main"
        create: yes
        owner: root
        group: root
        mode: '0644'

    - name: Update package cache and install Elasticsearch
      apt:
        name: elasticsearch
        state: present
        update_cache: yes

    - name: Set cluster.name in elasticsearch.yml
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?cluster\.name:'
        line: "cluster.name: {{ cluster_name }}"
        backup: yes

    - name: Set network.host to 0.0.0.0
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?network\.host:'
        line: "network.host: 0.0.0.0"

- name: Configure and start bootstrap node
  hosts: elasticsearch_bootstrap
  become: yes
  gather_facts: no

  tasks:
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Generate enrollment token on bootstrap node
  hosts: elasticsearch_bootstrap
  become: yes
  gather_facts: no

  tasks:
    - name: Generate enrollment token for new nodes
      shell: /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node
      register: enrollment_token_result

    - name: Store enrollment token as fact
      set_fact:
        enrollment_token: "{{ enrollment_token_result.stdout }}"

    - name: Display enrollment token
      debug:
        msg: "Enrollment token: {{ enrollment_token }}"

- name: Configure elasticsearch_master nodes
  hosts: elasticsearch_masters
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Display enrollment token
      debug:
        msg: "Enrollment token: {{ enrollment_token }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Display reconfigure output
      debug:
        var: reconfigure_result

    - name: Set node.roles for elasticsearch_master nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["master", "remote_cluster_client"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_hot nodes
  hosts: elasticsearch_hot
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_hot nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["data_hot", "data_content"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_cold nodes
  hosts: elasticsearch_cold
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_cold nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["data_cold"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_frozen nodes
  hosts: elasticsearch_frozen
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_frozen nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["data_frozen"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_warm nodes
  hosts: elasticsearch_warm
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_warm nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["data_warm"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_ingest nodes
  hosts: elasticsearch_ingest
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_ingest nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["ingest"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_ml nodes
  hosts: elasticsearch_ml
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_ml nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["ml"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_coordinating nodes
  hosts: elasticsearch_coordinating
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Set node.roles for elasticsearch_coordinating nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["remote_cluster_client"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started

- name: Configure elasticsearch_transform nodes
  hosts: elasticsearch_transform
  become: yes
  gather_facts: no

  tasks:
    - name: Get enrollment token from bootstrap node
      set_fact:
        enrollment_token: "{{ hostvars[groups['elasticsearch_bootstrap'][0]]['enrollment_token'] }}"

    - name: Reconfigure node with enrollment token
      shell: yes | /usr/share/elasticsearch/bin/elasticsearch-reconfigure-node -s --enrollment-token {{ enrollment_token }}
      register: reconfigure_result
      async: 60
      poll: 5

    - name: Display reconfigure output
      debug:
        var: reconfigure_result

    - name: Set node.roles for elasticsearch_transform nodes
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: '^#?node\.roles:'
        line: 'node.roles: ["transform"]'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Elasticsearch service
      systemd:
        name: elasticsearch.service
        enabled: yes
        state: started
