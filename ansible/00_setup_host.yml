---
- name: Install QEMU Guest Agent
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Install qemu-guest-agent
      apt:
        name: qemu-guest-agent
        state: present
        update_cache: yes

    - name: Enable and start qemu-guest-agent service
      systemd:
        name: qemu-guest-agent
        enabled: yes
        state: started

- name: Deploy a basic Linux server
  hosts: all
  gather_facts: false
  tasks:
    - name: Update and upgrade apt packages
      become: true
      apt:
        update_cache: true
        upgrade: dist

    - name: Install basic packages
      become: true
      apt:
        name:
          - git
          - python3-pip
          - zsh
          # Commented out for faster testing - uncomment if needed:
          # - curl
          # - vim
          # - unzip
          # - autoconf
          # - htop
          # - eslint
          # - gettext
          # - luajit
          # - neovim
          # - npm
          # - stow
          # - tmux
          # - openssl
          # - ripgrep
          # - fzf
          # - kitty-terminfo
        state: present

    - name: Test for dotfiles
      ansible.builtin.stat:
        path: ~/git/dotfile/.git
      register: file_check

    - name: Setup dotfiles and SSH keys for user bret
      become_user: bret
      block:
        - name: Ensure .ssh directory exists
          file:
            path: ~/.ssh
            state: directory
            mode: '0700'

        - name: Clean up all old host keys from localhost known_hosts
          shell: |
            # Remove all variations of the hostname
            ssh-keygen -R {{ inventory_hostname }} || true
            ssh-keygen -R {{ ansible_host | default(inventory_hostname) }} || true
            ssh-keygen -R {{ inventory_hostname.split('.')[0] }} || true
            # Also remove any remaining entries that contain the hostname
            sed -i.bak '/{{ inventory_hostname }}/d' ~/.ssh/known_hosts || true
            sed -i.bak '/{{ inventory_hostname.split('.')[0] }}/d' ~/.ssh/known_hosts || true
          delegate_to: localhost
          connection: local
          ignore_errors: yes

        - name: Add current host key to localhost known_hosts
          shell: ssh-keyscan -H {{ inventory_hostname }} >> ~/.ssh/known_hosts
          delegate_to: localhost
          connection: local

        - name: Test SSH connection to ensure host key is accepted
          shell: ssh -o BatchMode=yes -o StrictHostKeyChecking=no {{ ansible_user }}@{{ inventory_hostname }} 'echo "SSH connection test successful"'
          delegate_to: localhost
          connection: local
          ignore_errors: yes

        - name: Rsync SSH files from localhost
          shell: rsync -av /Users/bret/.ssh/github* /Users/bret/.ssh/config /Users/bret/.ssh/known_hosts {{ ansible_user }}@{{ inventory_hostname }}:.ssh/
          delegate_to: localhost
          connection: local

        - name: Create git directory
          file:
            path: ~/git
            state: directory

        - name: Clone dotfiles repository
          git:
            repo: git@github.com:wortmanb/dotfiles.git
            dest: ~/git/dotfiles
            clone: yes
            update: yes

        - name: Run linux setup script
          shell: ./__setup/linux.sh
          args:
            chdir: ~/git/dotfiles
          async: 1200
          poll: 10

        - name: Run setup script
          shell: ./setup.sh
          args:
            chdir: ~/git/dotfiles
      when: file_check.stat.exists == False

    - name: Change shell to zsh
      user:
        name: "{{ ansible_user }}"
        shell: /usr/bin/zsh
      become: true
      retries: 3
      delay: 5
