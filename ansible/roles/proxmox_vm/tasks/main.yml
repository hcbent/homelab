---
# Main task file for proxmox_vm role
# Handles Proxmox VM setup, configuration, and QEMU agent installation

# New VM setup actions (includes connection waiting and initial setup)
- name: Include initial VM setup tasks
  include_tasks: initial_setup.yml
  when: proxmox_vm_action == 'new_vm_setup'

- name: Include service configuration for new VMs
  include_tasks: configure_services.yml
  when: proxmox_vm_action == 'new_vm_setup'

- name: Include security updates configuration for new VMs
  include_tasks: security_updates.yml
  when: proxmox_vm_action == 'new_vm_setup' and enable_unattended_upgrades | default(true)

- name: Include status display for new VMs
  include_tasks: display_status.yml
  when: proxmox_vm_action == 'new_vm_setup'

# Basic host setup actions
- name: Include QEMU agent installation (basic)
  include_tasks: qemu_agent.yml
  when: proxmox_vm_action != 'new_vm_setup' and install_qemu_agent | default(true) and not qemu_agent_enhanced | default(false)

- name: Include QEMU agent installation (enhanced)
  include_tasks: qemu_agent_enhanced.yml
  when: proxmox_vm_action != 'new_vm_setup' and install_qemu_agent | default(true) and qemu_agent_enhanced | default(false)

- name: Include basic host setup
  include_tasks: basic_setup.yml
  when: proxmox_vm_action != 'new_vm_setup' and basic_host_setup | default(true)

- name: Include dotfiles setup
  include_tasks: dotfiles.yml
  when: proxmox_vm_action != 'new_vm_setup' and setup_dotfiles | default(true)