---
# Example playbook for installing Elastic Agent on all hosts
# Copy this file to add_agent.yml and configure for your environment
#
# IMPORTANT: Retrieve enrollment token from Vault or Fleet UI
# vault kv get secret/homelab/elasticsearch/fleet/enrollment-token

- name: Install Elastic Agent on all hosts
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    elastic_agent_version: "9.1.3"
    fleet_server_url: "https://fleet.lab.thewortmans.org:8220"
    # Retrieve from Vault: vault kv get -field=enrollment_token secret/homelab/elasticsearch/fleet/credentials
    # Or generate from Fleet UI: Settings > Fleet > Enrollment tokens
    enrollment_token: "VAULT_SECRET_REFERENCE"
    fleet_action: agent_install

  roles:
    - fleet

- name: Install Elastic Agent on Kubernetes nodes
  hosts: k8s
  become: yes
  gather_facts: yes
  vars:
    elastic_agent_version: "9.1.3"
    fleet_server_url: "https://fleet.lab.thewortmans.org:8220"
    # Retrieve from Vault: vault kv get -field=enrollment_token secret/homelab/elasticsearch/fleet/credentials
    enrollment_token: "VAULT_SECRET_REFERENCE"
    fleet_action: agent_install

  roles:
    - fleet

- name: Install Elastic Agent on Infrastructure nodes
  hosts: infrastructure
  become: yes
  gather_facts: yes
  vars:
    elastic_agent_version: "9.1.3"
    fleet_server_url: "https://fleet.lab.thewortmans.org:8220"
    # Retrieve from Vault: vault kv get -field=enrollment_token secret/homelab/elasticsearch/fleet/credentials
    enrollment_token: "VAULT_SECRET_REFERENCE"
    fleet_action: agent_install

  roles:
    - fleet
