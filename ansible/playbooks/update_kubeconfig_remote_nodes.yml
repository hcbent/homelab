---
# Playbook: Update kubeconfig files on remote K8s cluster nodes
#
# Purpose: Updates server endpoint in kubeconfig files on all remote K8s nodes
#          (control plane and workers) to use the load balancer VIP
#
# Target: Remote K8s control plane nodes (km01-03) and worker nodes (kube01-03)
# Dependencies: Task Group 4 must be complete (nginx LB operational)
# Spec: agent-os/specs/2025-11-05-nginx-lb-ha
#
# Usage:
#   # Test with check mode first:
#   ansible-playbook -i inventory/lab update_kubeconfig_remote_nodes.yml --check
#
#   # Run on one node first:
#   ansible-playbook -i inventory/lab update_kubeconfig_remote_nodes.yml --limit km01
#
#   # Run on all nodes:
#   ansible-playbook -i inventory/lab update_kubeconfig_remote_nodes.yml

- name: Update kubeconfig on remote Kubernetes nodes
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    # Load balancer VIP endpoint
    lb_vip: "192.168.10.250"
    lb_port: "6443"
    lb_endpoint: "https://{{ lb_vip }}:{{ lb_port }}"

    # Kubeconfig file locations on remote nodes
    kubeconfig_paths:
      - "/etc/kubernetes/admin.conf"
      - "/root/.kube/config"

    # User kubeconfig (if exists)
    user_kubeconfig_path: "/home/{{ ansible_user }}/.kube/config"

    # Backup timestamp format
    backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

    # K8s node groups to target
    k8s_node_groups:
      - "km01"
      - "km02"
      - "km03"
      - "kube01"
      - "kube02"
      - "kube03"

  tasks:
    - name: Display playbook information
      debug:
        msg:
          - "=============================================="
          - "Remote Kubeconfig Update for Load Balancer"
          - "=============================================="
          - "Target Endpoint: {{ lb_endpoint }}"
          - "Target Hosts: {{ ansible_play_hosts | join(', ') }}"
          - "Backup Timestamp: {{ backup_timestamp }}"
          - "=============================================="
      run_once: true

    # Pre-flight checks
    - name: Check if kubectl is installed
      command: which kubectl
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Display kubectl availability
      debug:
        msg: "kubectl is {{ 'available' if kubectl_check.rc == 0 else 'NOT available' }} on {{ inventory_hostname }}"

    # Find kubeconfig files
    - name: Check for kubeconfig files
      stat:
        path: "{{ item }}"
      register: kubeconfig_files
      loop: "{{ kubeconfig_paths + [user_kubeconfig_path] }}"

    - name: Build list of existing kubeconfig files
      set_fact:
        existing_configs: "{{ kubeconfig_files.results | selectattr('stat.exists') | map(attribute='item') | list }}"

    - name: Display found kubeconfig files
      debug:
        msg: "Found {{ existing_configs | length }} kubeconfig file(s) on {{ inventory_hostname }}: {{ existing_configs }}"

    - name: Skip host if no kubeconfig found
      meta: end_host
      when: existing_configs | length == 0

    # Backup phase
    - name: Create backup directory
      file:
        path: /root/.kube/backups
        state: directory
        mode: '0700'

    - name: Backup kubeconfig files
      copy:
        src: "{{ item }}"
        dest: "{{ item }}.backup.{{ backup_timestamp }}"
        remote_src: yes
        mode: preserve
      loop: "{{ existing_configs }}"
      register: backup_result

    - name: Verify backups created
      stat:
        path: "{{ item }}.backup.{{ backup_timestamp }}"
      register: backup_check
      loop: "{{ existing_configs }}"
      failed_when: not backup_check.stat.exists

    # Get current endpoint
    - name: Get current server endpoint
      shell: |
        grep "server:" {{ item }} | head -1 | awk '{print $2}'
      register: current_endpoint
      loop: "{{ existing_configs }}"
      changed_when: false

    - name: Display current endpoints
      debug:
        msg: "{{ inventory_hostname }}: {{ item.item }} -> {{ item.stdout }}"
      loop: "{{ current_endpoint.results }}"
      loop_control:
        label: "{{ item.item }}"

    # Update phase
    - name: Update server endpoint in kubeconfig files
      replace:
        path: "{{ item }}"
        regexp: 'server:\s+https://[^:\s]+:6443'
        replace: "server: {{ lb_endpoint }}"
        backup: no
      loop: "{{ existing_configs }}"
      register: update_result

    - name: Display update results
      debug:
        msg: "{{ inventory_hostname }}: Updated {{ item.item }} (changed: {{ item.changed }})"
      loop: "{{ update_result.results }}"
      loop_control:
        label: "{{ item.item }}"

    # Validation phase
    - name: Validate kubeconfig syntax
      command: kubectl --kubeconfig="{{ item }}" config view
      loop: "{{ existing_configs }}"
      changed_when: false
      when: kubectl_check.rc == 0

    - name: Verify updated endpoint
      shell: |
        grep "server:" {{ item }} | head -1 | awk '{print $2}'
      register: verify_endpoint
      loop: "{{ existing_configs }}"
      changed_when: false
      failed_when: verify_endpoint.stdout != lb_endpoint

    - name: Display verification results
      debug:
        msg: "{{ inventory_hostname }}: Verified {{ item.item }} -> {{ item.stdout }}"
      loop: "{{ verify_endpoint.results }}"
      loop_control:
        label: "{{ item.item }}"

    # Connectivity test (if kubectl available)
    - name: Test connectivity through load balancer
      command: kubectl --kubeconfig="{{ existing_configs[0] }}" get nodes
      register: connectivity_test
      changed_when: false
      failed_when: false
      when: kubectl_check.rc == 0

    - name: Display connectivity test result
      debug:
        msg:
          - "{{ inventory_hostname }}: Connectivity test {{ 'PASSED' if connectivity_test.rc == 0 else 'FAILED' }}"
          - "{{ connectivity_test.stdout_lines | default([]) }}"
      when: kubectl_check.rc == 0

    - name: Summary for this host
      debug:
        msg:
          - "=============================================="
          - "{{ inventory_hostname }}: Update Complete"
          - "=============================================="
          - "Updated {{ existing_configs | length }} file(s)"
          - "New endpoint: {{ lb_endpoint }}"
          - "Backups: {{ existing_configs | map('regex_replace', '^(.*)$', '\\1.backup.' + backup_timestamp) | list }}"
          - "Connectivity: {{ 'PASSED' if (kubectl_check.rc == 0 and connectivity_test.rc == 0) else 'SKIPPED/FAILED' }}"
          - "=============================================="

  # Error handling
  rescue:
    - name: Display error message
      debug:
        msg:
          - "=============================================="
          - "ERROR on {{ inventory_hostname }}"
          - "=============================================="
          - "Kubeconfig update failed. Backups available."
          - "=============================================="

    - name: Provide rollback instructions
      debug:
        msg:
          - "Rollback commands for {{ inventory_hostname }}:"
          - "{% for config in existing_configs %}"
          - "  cp {{ config }}.backup.{{ backup_timestamp }} {{ config }}"
          - "{% endfor %}"

# Final summary across all hosts
- name: Display final summary
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Overall completion summary
      debug:
        msg:
          - "=============================================="
          - "Kubeconfig Update Summary"
          - "=============================================="
          - "Playbook completed for all target hosts"
          - "Target endpoint: https://{{ lb_vip }}:6443"
          - "Review host-specific results above"
          - "=============================================="
      run_once: true
