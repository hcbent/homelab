# nginx Stream Configuration - Kubernetes API Server (Layer 4)
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# Purpose: Load balances TCP port 6443 traffic to control plane nodes
# Provides TLS passthrough for end-to-end encryption

# Upstream for Kubernetes API servers (control plane nodes)
upstream k8s_api_servers {
    {{ nginx_config.lb_method }};  # Load balancing method
{% for node in k8s_control_plane %}
    server {{ node.ip }}:{{ nginx_config.k8s_api_port }} max_fails={{ nginx_config.max_fails }} fail_timeout={{ nginx_config.fail_timeout }};
{% endfor %}
}

# Stream server for K8s API
server {
    listen {{ nginx_config.k8s_api_port }};
    proxy_pass k8s_api_servers;
    proxy_timeout {{ nginx_config.k8s_api_proxy_timeout }};
    proxy_connect_timeout {{ nginx_config.k8s_api_proxy_connect_timeout }};
}
