# nginx HTTP Configuration - NodePort Services (Layer 7)
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# Purpose: Load balances HTTP/HTTPS traffic to worker nodes for NodePort services

# ============================================
# UPSTREAM DEFINITIONS - NodePort Services
# ============================================
# Each upstream targets worker nodes on the NodePort

{% for service in services %}
# {{ service.description }}
upstream {{ service.name }} {
    {{ nginx_config.lb_method }};  # Use least connections load balancing
{% for worker in k8s_workers %}
    server {{ worker.ip }}:{{ service.node_port }} max_fails={{ nginx_config.max_fails }} fail_timeout={{ nginx_config.fail_timeout }};
{% endfor %}
}

{% endfor %}

# ============================================
# SERVER BLOCKS - NodePort Services
# ============================================

{% for service in services %}
# {{ service.description }}
server {
    listen {{ service.listen_port }}{% if 'https' in service.name %} ssl{% endif %};
    server_name _;

{% if 'https' in service.name %}
    # Self-signed certificate (replace with proper certs in production)
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

    # SSL Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

{% endif %}
    location / {
{% if 'actualbudget' in service.name or 'mealie' in service.name or 'sonarr' in service.name or 'radarr' in service.name or 'qbittorrent' in service.name %}
	client_max_body_size 50M;
{% endif %}
        proxy_pass http://{{ service.name }};
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto {% if 'https' in service.name %}https{% else %}$scheme{% endif %};
        proxy_set_header X-Forwarded-Host $host:$server_port;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout {{ nginx_config.proxy_connect_timeout }};
        proxy_send_timeout {{ nginx_config.proxy_send_timeout }};
        proxy_read_timeout {{ nginx_config.proxy_read_timeout }};

{% if 'actualbudget' in service.name %}
        # SharedArrayBuffer support for Actualbudget
        # Hide any conflicting headers from the backend
        proxy_hide_header Cross-Origin-Opener-Policy;
        proxy_hide_header Cross-Origin-Embedder-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        # Set required headers for SharedArrayBuffer
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
{% endif %}
    }
}

{% endfor %}

# ============================================
# HEALTH CHECK ENDPOINT
# ============================================
# Simple health check endpoint for monitoring

server {
    listen {{ nginx_config.health_check_port }};
    server_name _;

    location {{ nginx_config.health_check_path }} {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
