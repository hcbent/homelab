# External Secrets Operator Implementation Summary

## Overview

This document summarizes the implementation of External Secrets Operator (ESO) for the homelab Kubernetes cluster. ESO automates the synchronization of secrets from HashiCorp Vault to Kubernetes Secret objects, eliminating manual secret management.

## Implementation Date
2024-11-04

## Objectives Achieved

- ✅ External Secrets Operator deployed via ArgoCD
- ✅ ClusterSecretStore configured for Vault backend
- ✅ ExternalSecret resources created for all services with secrets
- ✅ Kubernetes manifests updated to use auto-generated secrets
- ✅ All VAULT_SECRET_REFERENCE placeholders replaced
- ✅ Comprehensive documentation created

## Architecture

```
Vault (192.168.10.101:8200)
    ↓
ClusterSecretStore (vault-backend)
    ↓
ExternalSecret Resources
    ↓
Auto-generated Kubernetes Secrets
    ↓
Applications (Pi-hole, Paperless, Cerebro, etc.)
```

## Files Created

### ArgoCD Application
- **`k8s/external-secrets-app.yaml`**
  - ArgoCD application definition for ESO
  - Uses Helm chart from https://charts.external-secrets.io
  - Version: 0.10.0
  - Deploys to: `external-secrets-system` namespace

### ESO Configuration
- **`k8s/external-secrets/values.yaml`**
  - Helm values for ESO deployment
  - Configures RBAC, security context, metrics

- **`k8s/external-secrets/vault-secret-store.yaml`**
  - ClusterSecretStore definition for Vault backend
  - Token-based authentication (can be upgraded to Kubernetes auth)
  - Connects to: https://192.168.10.101:8200

- **`k8s/external-secrets/README.md`**
  - Quick start guide for ESO configuration
  - Lists all ExternalSecrets in the cluster

- **`k8s/external-secrets/external-secret.example.yaml`**
  - Example ExternalSecret resource
  - Shows different patterns for secret retrieval
  - Demonstrates usage in deployments

### ExternalSecret Resources
- **`k8s/pihole/external-secret.yaml`**
  - Syncs Pi-hole web password from Vault
  - Path: `secret/homelab/pihole/lab/credentials`
  - Target secret: `pihole-secret` in `pihole` namespace

- **`k8s/paperless/external-secret.yaml`**
  - Syncs Paperless database credentials
  - Path: `secret/homelab/databases/paperless`
  - Target secret: `paperless-db-secret` in `default` namespace

- **`k8s/cerebro/external-secret.yaml`**
  - Syncs Cerebro Elasticsearch password
  - Path: `secret/homelab/elasticsearch/cerebro`
  - Target secret: `cerebro-secret` in `elastic-stack` namespace

- **`k8s/prometheus/external-secret.yaml`**
  - Syncs Grafana admin password
  - Path: `secret/homelab/prometheus/lab/credentials`
  - Target secret: `prometheus-grafana-secret` in `prometheus` namespace

- **`k8s/freenas/external-secret.yaml`**
  - Syncs TrueNAS credentials for Democratic CSI
  - Path: `secret/homelab/freenas/credentials`
  - Target secret: `freenas-credentials` in `democratic-csi` namespace

- **`k8s/unpackerr/external-secret.yaml`**
  - Syncs Radarr and Sonarr API keys
  - Paths: `secret/homelab/apps/radarr`, `secret/homelab/apps/sonarr`
  - Target secret: `unpackerr-secret` in `default` namespace

## Files Modified

### Application Manifests
- **`k8s/pihole/pihole.yaml`**
  - Removed hardcoded Secret with VAULT_SECRET_REFERENCE
  - Now uses `pihole-secret` auto-generated by ESO
  - Secret is mounted via `secretRef` in deployment

- **`k8s/cerebro/cerebro.yaml`**
  - Removed password from ConfigMap
  - Added environment variable reference to `cerebro-secret`
  - Password injected via `secretKeyRef`

- **`k8s/home-apps/unpackerr-deployment.yaml`**
  - Replaced hardcoded API keys
  - Now uses `unpackerr-secret` for Radarr and Sonarr API keys
  - Credentials referenced via `secretKeyRef`

### Helm Values
- **`k8s/helm/values/prometheus.yaml`**
  - Configured Grafana to use `existingSecret`
  - References `prometheus-grafana-secret` auto-generated by ESO

- **`k8s/helm/values/freenas-iscsi.yaml`**
  - Added comment about using `freenas-credentials` secret
  - Noted `passwordFromSecret` pattern for Democratic CSI

- **`k8s/helm/values/freenas-nfs.yaml`**
  - Added comment about using `freenas-credentials` secret
  - Noted `passwordFromSecret` pattern for SSH authentication

## Documentation Created

- **`docs/EXTERNAL-SECRETS-SETUP.md`** (Comprehensive guide)
  - Architecture overview and diagrams
  - Component descriptions
  - Installation procedures
  - Configuration details
  - Troubleshooting guide
  - Security best practices
  - Monitoring and alerting
  - Secret rotation procedures
  - Example commands reference

- **`docs/EXTERNAL-SECRETS-DEPLOYMENT.md`** (Step-by-step deployment)
  - Prerequisites checklist
  - 10-step deployment procedure
  - Post-deployment verification
  - Troubleshooting common issues
  - Rollback procedures
  - Maintenance schedule

## Secret Mappings

| Service | Vault Path | Kubernetes Secret | Namespace | Keys |
|---------|-----------|------------------|-----------|------|
| Pi-hole | `secret/homelab/pihole/lab/credentials` | `pihole-secret` | `pihole` | `WEBPASSWORD` |
| Paperless | `secret/homelab/databases/paperless` | `paperless-db-secret` | `default` | `admin_password`, `db_password`, `db_user`, `db_name` |
| Cerebro | `secret/homelab/elasticsearch/cerebro` | `cerebro-secret` | `elastic-stack` | `password` |
| Grafana | `secret/homelab/prometheus/lab/credentials` | `prometheus-grafana-secret` | `prometheus` | `admin-password`, `admin-user` |
| Democratic CSI | `secret/homelab/freenas/credentials` | `freenas-credentials` | `democratic-csi` | `password`, `api_key`, `ssh_password` |
| Unpackerr | `secret/homelab/apps/radarr` + `sonarr` | `unpackerr-secret` | `default` | `radarr_api_key`, `sonarr_api_key` |

## Deployment Instructions

### Quick Start

```bash
# 1. Deploy ESO via ArgoCD
kubectl apply -f k8s/external-secrets-app.yaml

# 2. Create Vault token secret
kubectl create secret generic vault-token \
  -n external-secrets-system \
  --from-literal=token="<your-vault-token>"

# 3. Apply ClusterSecretStore
kubectl apply -f k8s/external-secrets/vault-secret-store.yaml

# 4. Deploy all ExternalSecrets
kubectl apply -f k8s/pihole/external-secret.yaml
kubectl apply -f k8s/paperless/external-secret.yaml
kubectl apply -f k8s/cerebro/external-secret.yaml
kubectl apply -f k8s/prometheus/external-secret.yaml
kubectl apply -f k8s/freenas/external-secret.yaml
kubectl apply -f k8s/unpackerr/external-secret.yaml

# 5. Verify
kubectl get externalsecret -A
kubectl get secret pihole-secret -n pihole
```

### Detailed Instructions

See [docs/EXTERNAL-SECRETS-DEPLOYMENT.md](docs/EXTERNAL-SECRETS-DEPLOYMENT.md) for comprehensive step-by-step instructions.

## Verification Checklist

After deployment, verify the following:

- [ ] ESO pods are running in `external-secrets-system` namespace
- [ ] ClusterSecretStore `vault-backend` shows READY=True
- [ ] All ExternalSecrets show STATUS=SecretSynced and READY=True
- [ ] Kubernetes Secrets exist in their respective namespaces
- [ ] Applications can start and access their secrets
- [ ] No error events in namespaces related to secrets
- [ ] ESO logs show successful syncs

```bash
# Run verification commands
kubectl get pods -n external-secrets-system
kubectl get clustersecretstore vault-backend
kubectl get externalsecret -A
kubectl get secret -A | grep -E 'pihole-secret|cerebro-secret|prometheus-grafana-secret'
kubectl logs -n external-secrets-system deployment/external-secrets --tail=20
```

## Security Considerations

### Current Implementation
- **Authentication**: Token-based (stored in `vault-token` secret)
- **TLS**: Self-signed certificate (skip-verify may be needed)
- **Permissions**: Token should have minimal required Vault policies
- **Token Rotation**: Manual (should rotate quarterly)

### Recommended Improvements
1. **Migrate to Kubernetes Auth**: More secure than long-lived tokens
2. **Proper TLS**: Use valid certificates or configure CA bundle
3. **Namespace Isolation**: Consider using SecretStore instead of ClusterSecretStore for sensitive namespaces
4. **RBAC**: Restrict access to ExternalSecret and SecretStore resources
5. **Audit Logging**: Enable Vault audit logs for secret access tracking

See [docs/EXTERNAL-SECRETS-SETUP.md](docs/EXTERNAL-SECRETS-SETUP.md) for detailed security best practices.

## Operational Procedures

### Monitoring
- ESO exposes Prometheus metrics on port 8080
- Key metrics: `externalsecret_status_condition`, `externalsecret_sync_calls_total`
- Review logs weekly for errors

### Secret Rotation
1. Update secret in Vault
2. Wait for refresh interval (1 hour) or force sync
3. Restart affected applications

### Adding New Secrets
1. Store secret in Vault under `secret/homelab/`
2. Create ExternalSecret resource
3. Apply and verify sync
4. Update application to reference the new secret

### Troubleshooting
- Check ESO logs: `kubectl logs -n external-secrets-system deployment/external-secrets`
- Describe ExternalSecret: `kubectl describe externalsecret <name> -n <namespace>`
- Test Vault connectivity from cluster
- Verify Vault token permissions

## Migration Notes

### Before ESO
- Secrets had `VAULT_SECRET_REFERENCE` placeholders
- Manual retrieval from Vault required
- Risk of secrets being committed to Git
- No automatic rotation

### After ESO
- Secrets automatically synced from Vault
- No manual intervention needed
- Secrets never stored in Git
- Automatic refresh every hour
- Centralized secret management in Vault

## Rollback Plan

If issues arise, rollback procedure:

1. Delete ExternalSecret resources
2. Delete ClusterSecretStore
3. Create manual Kubernetes secrets
4. Applications will use manually created secrets

See [docs/EXTERNAL-SECRETS-DEPLOYMENT.md](docs/EXTERNAL-SECRETS-DEPLOYMENT.md#rollback-procedure) for detailed steps.

## Future Enhancements

1. **Kubernetes Auth**: Implement Vault Kubernetes auth method
2. **Monitoring**: Add Prometheus alerts for failed syncs
3. **Automation**: Create CI/CD pipeline for ExternalSecret updates
4. **Multi-Cluster**: Extend to other clusters if needed
5. **Secret Versioning**: Implement secret version pinning for critical services

## Testing

### Test Secret Sync
```bash
# Update a secret in Vault
vault kv put secret/homelab/test/credentials password=test123

# Create ExternalSecret
kubectl apply -f - <<EOF
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: test-secret
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: test-secret
  dataFrom:
    - extract:
        key: homelab/test/credentials
EOF

# Verify sync
kubectl get externalsecret test-secret
kubectl get secret test-secret -o yaml
```

### Test Secret Rotation
```bash
# Update the secret in Vault
vault kv put secret/homelab/test/credentials password=newtest456

# Force immediate sync
kubectl annotate externalsecret test-secret force-sync=$(date +%s) --overwrite

# Verify update
kubectl get secret test-secret -o jsonpath='{.data.password}' | base64 -d
```

## References

- [External Secrets Operator Documentation](https://external-secrets.io/)
- [Vault Documentation](https://developer.hashicorp.com/vault/docs)
- [Kubernetes Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)
- [ArgoCD Applications](https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/)

## Support Contacts

For questions or issues:
1. Review documentation in `docs/EXTERNAL-SECRETS-*.md`
2. Check ESO logs and status
3. Consult External Secrets Operator GitHub issues
4. Review Vault audit logs

## Conclusion

The External Secrets Operator implementation successfully automates secret management in the homelab Kubernetes cluster. All secrets are now centrally managed in Vault and automatically synchronized to Kubernetes, improving security and operational efficiency.

**Status**: ✅ Implementation Complete
**Next Steps**: Monitor ESO for 1 week, then consider migrating to Kubernetes auth method
