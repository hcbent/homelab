# qBittorrent Helm Values Configuration
# Using bjw-s app-template chart
# Chart: https://bjw-s-labs.github.io/helm-charts/

# Default controller configuration
controllers:
  main:
    initContainers:
      config-setup:
        image:
          repository: busybox
          tag: latest
        command:
          - /bin/sh
          - -c
          - |
            CONF=/config/qBittorrent/qBittorrent.conf
            if [ -f "$CONF" ]; then
              echo "Configuring qBittorrent security settings..."
              # Remove ALL AutoRun settings (malware injection point)
              sed -i '/\[AutoRun\]/d' "$CONF"
              sed -i '/OnTorrentAdded/d' "$CONF"
              sed -i '/OnTorrentFinished/d' "$CONF"
              sed -i '/^enabled=/d' "$CONF"
              sed -i '/^program=/d' "$CONF"
              # Remove existing WebUI security settings (wherever they are)
              sed -i '/AuthSubnetWhitelistEnabled/d' "$CONF"
              sed -i '/AuthSubnetWhitelist=/d' "$CONF"
              sed -i '/CSRFProtection/d' "$CONF"
              sed -i '/HostHeaderValidation/d' "$CONF"
              sed -i '/LocalHostAuth/d' "$CONF"
              sed -i '/ReverseProxySupportEnabled/d' "$CONF"
              sed -i '/TrustedReverseProxiesList/d' "$CONF"
              # Add settings UNDER [Preferences] section (after WebUI\Username line)
              sed -i '/WebUI\\Username=/a WebUI\\ReverseProxySupportEnabled=true' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\TrustedReverseProxiesList=10.0.0.0/8, 192.168.0.0/16' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\AuthSubnetWhitelistEnabled=true' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\AuthSubnetWhitelist=192.168.0.0/16, 10.0.0.0/8, 127.0.0.0/8' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\CSRFProtection=false' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\HostHeaderValidation=false' "$CONF"
              sed -i '/WebUI\\Username=/a WebUI\\LocalHostAuth=false' "$CONF"
              echo "Configuration complete."
            else
              echo "Config file does not exist yet, will be created on first run."
            fi
    containers:
      main:
        image:
          repository: lscr.io/linuxserver/qbittorrent
          tag: latest
          pullPolicy: IfNotPresent

        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "America/New_York"
          WEBUI_PORT: "8080"

        probes:
          liveness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 8080
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 5
          readiness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 8080
              initialDelaySeconds: 30
              periodSeconds: 5
              timeoutSeconds: 5

# Service configuration - NodePort per project guidelines
service:
  main:
    controller: main
    type: NodePort
    ports:
      http:
        port: 8080
        targetPort: 8080
        protocol: TCP
      bittorrent-tcp:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: TCP
      bittorrent-udp:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: UDP

# Ingress disabled - external routing handled by NGINX Proxy Manager
ingress:
  main:
    enabled: false
    hosts: []

# Persistent storage configuration
persistence:
  # Config storage on iSCSI (RWO)
  config:
    enabled: true
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 5Gi
    storageClass: freenas-iscsi-csi
    retain: true
    # Annotations to prevent ArgoCD pruning
    annotations:
      argocd.argoproj.io/sync-options: Prune=false
    globalMounts:
      - path: /config

  # Downloads storage on Synology NFS (RWX) - references existing PV
  downloads:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: downloads-storage-pvc
    globalMounts:
      - path: /downloads

  # Media storage on Synology NFS (RWX) - references existing PV
  media:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: media-storage-pvc
    globalMounts:
      - path: /data

# Resource limits
resources:
  requests:
    memory: "512Mi"
    cpu: "200m"
  limits:
    memory: "2Gi"
    cpu: "2000m"

# Security context for LinuxServer.io container
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  fsGroupChangePolicy: OnRootMismatch
