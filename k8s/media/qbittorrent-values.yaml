# qBittorrent Helm Values Configuration
# Using bjw-s app-template chart
# Chart: https://bjw-s-labs.github.io/helm-charts/

# Default controller configuration
controllers:
  main:
    containers:
      main:
        image:
          repository: lscr.io/linuxserver/qbittorrent
          tag: latest
          pullPolicy: IfNotPresent

        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "America/New_York"
          WEBUI_PORT: "8080"

        probes:
          liveness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 8080
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 5
          readiness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 8080
              initialDelaySeconds: 30
              periodSeconds: 5
              timeoutSeconds: 5

        # Lifecycle hooks to enforce security and remove malware on every startup
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  # Wait for qBittorrent to create config file
                  CONF=/config/qBittorrent/qBittorrent.conf
                  while [ ! -f "$CONF" ]; do sleep 1; done
                  sleep 5  # Wait for qBittorrent to finish writing initial config

                  # Kill any malicious processes
                  pkill -f "yify.foo" 2>/dev/null || true
                  pkill -f "anondns.net" 2>/dev/null || true

                  # Remove ALL AutoRun settings (malware injection point)
                  sed -i '/\[AutoRun\]/d' "$CONF"
                  sed -i '/OnTorrentAdded/d' "$CONF"
                  sed -i '/OnTorrentFinished/d' "$CONF"
                  sed -i '/^enabled=/d' "$CONF"
                  sed -i '/^program=/d' "$CONF"

                  # Enforce security settings - REQUIRE authentication
                  sed -i '/AuthSubnetWhitelistEnabled/d' "$CONF"
                  sed -i '/AuthSubnetWhitelist=/d' "$CONF"
                  sed -i '/CSRFProtection/d' "$CONF"
                  sed -i '/HostHeaderValidation/d' "$CONF"

                  # Add secure settings - allow local network access without password
                  # but require auth from other sources. HostHeaderValidation=false
                  # allows access by IP address for local administration.
                  echo 'WebUI\AuthSubnetWhitelistEnabled=true' >> "$CONF"
                  echo 'WebUI\AuthSubnetWhitelist=192.168.0.0/16, 10.0.0.0/8' >> "$CONF"
                  echo 'WebUI\CSRFProtection=false' >> "$CONF"
                  echo 'WebUI\HostHeaderValidation=false' >> "$CONF"
                  echo 'WebUI\LocalHostAuth=false' >> "$CONF"

# Service configuration - NodePort per project guidelines
service:
  main:
    controller: main
    type: NodePort
    ports:
      http:
        port: 8080
        targetPort: 8080
        protocol: TCP
      bittorrent-tcp:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: TCP
      bittorrent-udp:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: UDP

# Ingress disabled - external routing handled by NGINX Proxy Manager
ingress:
  main:
    enabled: false
    hosts: []

# Persistent storage configuration
persistence:
  # Config storage on iSCSI (RWO)
  config:
    enabled: true
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 5Gi
    storageClass: freenas-iscsi-csi
    retain: true
    # Annotations to prevent ArgoCD pruning
    annotations:
      argocd.argoproj.io/sync-options: Prune=false
    globalMounts:
      - path: /config

  # Downloads storage on Synology NFS (RWX) - references existing PV
  downloads:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: downloads-storage-pvc
    globalMounts:
      - path: /downloads

  # Media storage on Synology NFS (RWX) - references existing PV
  media:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: media-storage-pvc
    globalMounts:
      - path: /data

# Resource limits
resources:
  requests:
    memory: "512Mi"
    cpu: "200m"
  limits:
    memory: "2Gi"
    cpu: "2000m"

# Security context for LinuxServer.io container
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  fsGroupChangePolicy: OnRootMismatch
