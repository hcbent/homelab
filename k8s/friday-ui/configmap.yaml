apiVersion: v1
kind: ConfigMap
metadata:
  name: friday-ui-app
  namespace: friday-ui
data:
  server.py: |
    #!/usr/bin/env python3
    """Friday UI ‚Äî lightweight HTTP server with state API."""
    import http.server
    import json
    import os
    import threading
    import time

    PORT = int(os.environ.get("PORT", 8080))
    STATE = {"state": "idle", "source": "manual"}
    lock = threading.Lock()
    manual_override = False
    manual_override_until = 0


    class Handler(http.server.SimpleHTTPRequestHandler):
        def __init__(self, *args, **kwargs):
            super().__init__(*args, directory="/app", **kwargs)

        def do_GET(self):
            if self.path == "/api/state":
                self.send_response(200)
                self.send_header("Content-Type", "application/json")
                self.send_header("Access-Control-Allow-Origin", "*")
                self.end_headers()
                with lock:
                    self.wfile.write(json.dumps(STATE).encode())
            else:
                super().do_GET()

        def do_POST(self):
            global manual_override, manual_override_until
            if self.path == "/api/state":
                length = int(self.headers.get("Content-Length", 0))
                body = json.loads(self.rfile.read(length)) if length else {}
                new = body.get("state", "idle")
                valid = {"idle", "thinking", "working", "coding", "alert", "speaking"}
                if new in valid:
                    with lock:
                        STATE["state"] = new
                        STATE["source"] = body.get("source", "api")
                    manual_override = True
                    manual_override_until = time.time() + 30
                    self.send_response(200)
                    self.send_header("Content-Type", "application/json")
                    self.send_header("Access-Control-Allow-Origin", "*")
                    self.end_headers()
                    self.wfile.write(json.dumps({"ok": True, "state": new}).encode())
                else:
                    self.send_response(400)
                    self.end_headers()
                    self.wfile.write(b'{"error":"invalid state"}')
            else:
                self.send_response(404)
                self.end_headers()

        def do_OPTIONS(self):
            self.send_response(204)
            self.send_header("Access-Control-Allow-Origin", "*")
            self.send_header("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
            self.send_header("Access-Control-Allow-Headers", "Content-Type")
            self.end_headers()

        def log_message(self, fmt, *args):
            pass


    if __name__ == "__main__":
        with http.server.HTTPServer(("", PORT), Handler) as srv:
            print(f"üê± Friday UI ‚Üí http://localhost:{PORT}", flush=True)
            srv.serve_forever()
