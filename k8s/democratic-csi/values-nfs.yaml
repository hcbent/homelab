# Democratic CSI Helm values for FreeNAS NFS driver
# Reference: https://github.com/democratic-csi/charts

nameOverride: ""
fullnameOverride: "freenas-nfs"

csiDriver:
  name: "org.democratic-csi.nfs"
  version: 1.5.0
  enabled: true
  attachRequired: false
  podInfoOnMount: true
  fsGroupPolicy: File

controller:
  enabled: true
  replicaCount: 1
  strategy: deployment
  priorityClassName: "system-cluster-critical"

  externalAttacher:
    enabled: false

  externalProvisioner:
    enabled: true
    image:
      registry: registry.k8s.io/sig-storage/csi-provisioner
      tag: v3.6.0
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

  externalResizer:
    enabled: true
    image:
      registry: registry.k8s.io/sig-storage/csi-resizer
      tag: v1.9.0
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

  externalSnapshotter:
    enabled: true
    image:
      registry: registry.k8s.io/sig-storage/csi-snapshotter
      tag: v8.2.1
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

  driver:
    enabled: true
    image:
      registry: docker.io/democraticcsi/democratic-csi
      tag: latest
    logLevel: info
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 512Mi

node:
  enabled: true
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  hostIPC: true
  priorityClassName: "system-node-critical"

  driver:
    enabled: true
    image:
      registry: docker.io/democraticcsi/democratic-csi
      tag: latest
    logLevel: info
    localtimeHostPath: /etc/localtime
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 512Mi

  driverRegistrar:
    enabled: true
    image:
      registry: registry.k8s.io/sig-storage/csi-node-driver-registrar
      tag: v2.9.0
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

csiProxy:
  enabled: true
  image:
    registry: docker.io/democraticcsi/csi-grpc-proxy
    tag: v0.5.6
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      memory: 128Mi

driver:
  # This configuration should be customized with actual FreeNAS details
  # Retrieve credentials from Vault: secret/homelab/freenas/credentials
  config:
    driver: freenas-nfs

    instance_id:
    # Credentials are injected via Helm --set flags from Vault
    # See deploy-democratic-csi.sh script
    httpConnection:
      protocol: http
      host: ""  # Set via --set from Vault
      port: 80
      apiKey: ""  # Set via --set from Vault
      allowInsecure: true
      apiVersion: 2

    sshConnection:
      host: ""  # Set via --set from Vault
      port: 22
      username: ""  # Set via --set from Vault
      privateKey: ""  # Set via --set from Vault

    zfs:
      cli:
        sudoEnabled: false
        paths:
          zfs: /usr/sbin/zfs
          zpool: /usr/sbin/zpool
          sudo: /usr/bin/sudo
          chroot: /usr/sbin/chroot
      # Storage pool configuration
      datasetParentName: tank/k8s/nfs
      detachedSnapshotsDatasetParentName: tank/k8s/nfs-snapshots
      datasetEnableQuotas: true
      datasetEnableReservation: false
      datasetPermissionsMode: "0777"
      datasetPermissionsUser: 0
      datasetPermissionsGroup: 0

    nfs:
      shareHost: "truenas.lab.thewortmans.org"
      shareAlldirs: false
      shareAllowedHosts: []
      shareAllowedNetworks: []
      shareMaprootUser: root
      shareMaprootGroup: wheel
      shareMapallUser: ""
      shareMapallGroup: ""

storageClasses:
  - name: freenas-nfs-csi
    defaultClass: false
    reclaimPolicy: Delete
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    parameters:
      fsType: nfs
    mountOptions:
      - nfsvers=4
      - nolock
      - soft
    secrets:
      provisioner-secret:
      controller-publish-secret:
      node-stage-secret:
      node-publish-secret:
      controller-expand-secret:

volumeSnapshotClasses:
  - name: freenas-nfs-snapshots
    deletionPolicy: Delete
    parameters: {}
