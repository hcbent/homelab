# Example ExternalSecret Resource
# This demonstrates how to create an ExternalSecret that syncs from Vault

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: example-secret
  namespace: default
spec:
  # How often to check Vault for updates (supports: 1h, 30m, 24h, etc.)
  refreshInterval: 1h

  # Reference to the ClusterSecretStore or SecretStore
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore

  # Target Kubernetes Secret configuration
  target:
    name: example-secret  # Name of the Kubernetes Secret to create
    creationPolicy: Owner  # ESO will own and manage this secret
    template:
      type: Opaque
      data:
        # Map Vault keys to Kubernetes secret keys
        # Use Go templates to transform data if needed
        username: "{{ .username }}"
        password: "{{ .password }}"
        # You can also base64 encode if needed
        encoded_password: "{{ .password | b64enc }}"

  # Method 1: Extract all keys from a single Vault path
  dataFrom:
    - extract:
        key: homelab/example/credentials  # Path in Vault (without 'secret/' prefix)

---
# Alternative Example: Fetching specific keys from multiple paths
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: example-multi-path-secret
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: example-multi-path-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        db_host: "{{ .db_host }}"
        db_password: "{{ .db_password }}"
        api_key: "{{ .api_key }}"

  # Method 2: Fetch specific keys from different Vault paths
  data:
    - secretKey: db_host
      remoteRef:
        key: homelab/database/config
        property: host
    - secretKey: db_password
      remoteRef:
        key: homelab/database/credentials
        property: password
    - secretKey: api_key
      remoteRef:
        key: homelab/app/credentials
        property: api_key

---
# Example: Using the secret in a Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: app
        image: nginx:latest
        # Method 1: Use entire secret as environment variables
        envFrom:
        - secretRef:
            name: example-secret
        # Method 2: Use specific keys as environment variables
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: example-multi-path-secret
              key: db_host
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: example-multi-path-secret
              key: db_password
        # Method 3: Mount as files
        volumeMounts:
        - name: secrets
          mountPath: /etc/secrets
          readOnly: true
      volumes:
      - name: secrets
        secret:
          secretName: example-secret
