---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: pihole
---
# MetalLB IPAddressPool for Pi-hole specific IP
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pihole-pool
  namespace: metallb-system
spec:
  addresses:
    - 192.168.10.53/32
  autoAssign: false
---
# L2Advertisement for Pi-hole pool
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: pihole-l2advert
  namespace: metallb-system
spec:
  ipAddressPools:
    - pihole-pool
---
# Secret for Pi-hole web password - CREATE MANUALLY (not stored in git):
# kubectl create namespace pihole
# kubectl create secret generic pihole-secret -n pihole \
#   --from-literal=WEBPASSWORD=$(vault kv get -field=webpassword secret/homelab/pihole/lab/credentials)
---
# ConfigMap for Pi-hole configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: pihole-config
  namespace: pihole
data:
  TZ: "America/New_York"
  DNSMASQ_LISTENING: "all"
  FTLCONF_dns_listeningMode: "all"
  # Use 'lan' as local domain - thewortmans.org is managed by UDM
  FTLCONF_dns_domain_name: "lan"
  # Upstream DNS servers are configured via Pi-hole UI
  FTLCONF_dns_blockESNI: "true"
  FTLCONF_dns_specialDomains_mozillaCanary: "true"
  FTLCONF_dns_specialDomains_iCloudPrivateRelay: "true"
  # Enable reading custom dnsmasq configs from /etc/dnsmasq.d/
  FTLCONF_misc_etc_dnsmasq_d: "true"
---
# ConfigMap for adlists to import
apiVersion: v1
kind: ConfigMap
metadata:
  name: pihole-adlists
  namespace: pihole
data:
  adlists.list: |
    https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
    https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts
    https://nsfw.oisd.nl/domainswild
    https://raw.githubusercontent.com/Sinfonietta/hostfiles/master/pornography-hosts
---
# ConfigMap for custom dnsmasq settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: pihole-dnsmasq-custom
  namespace: pihole
data:
  99-custom.conf: |
    dns-forward-max=500
    # Wildcard for home.lab -> nginx-proxy-manager (Tailscale IP)
    address=/home.lab/100.123.46.74
    # Forward thewortmans.org to UDM for local DNS records
    server=/thewortmans.org/192.168.1.1
---
# PVC for Pi-hole config
# Protected from ArgoCD pruning with annotations and finalizers
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pihole-config-pvc
  namespace: pihole
  annotations:
    # Prevent ArgoCD from deleting this PVC during sync/prune operations
    argocd.argoproj.io/sync-options: Prune=false
  finalizers:
    # Kubernetes built-in protection - prevents deletion while in use
    - kubernetes.io/pvc-protection
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: freenas-iscsi-csi
---
# PVC for dnsmasq config
# Protected from ArgoCD pruning with annotations and finalizers
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pihole-dnsmasq-pvc
  namespace: pihole
  annotations:
    # Prevent ArgoCD from deleting this PVC during sync/prune operations
    argocd.argoproj.io/sync-options: Prune=false
  finalizers:
    # Kubernetes built-in protection - prevents deletion while in use
    - kubernetes.io/pvc-protection
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
  storageClassName: freenas-iscsi-csi
---
# Pi-hole Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pihole
  namespace: pihole
  labels:
    app: pihole
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pihole
  template:
    metadata:
      labels:
        app: pihole
    spec:
      containers:
        - name: pihole
          image: pihole/pihole:latest
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
          ports:
            - containerPort: 53
              name: dns-tcp
              protocol: TCP
            - containerPort: 53
              name: dns-udp
              protocol: UDP
            - containerPort: 80
              name: http
              protocol: TCP
          envFrom:
            - configMapRef:
                name: pihole-config
            - secretRef:
                name: pihole-secret
          volumeMounts:
            - name: pihole-config-volume
              mountPath: /etc/pihole
            - name: dnsmasq-config-volume
              mountPath: /etc/dnsmasq.d
            - name: adlists
              mountPath: /etc/pihole/adlists.list
              subPath: adlists.list
            - name: dnsmasq-custom
              mountPath: /etc/dnsmasq.d/99-custom.conf
              subPath: 99-custom.conf
          livenessProbe:
            httpGet:
              path: /admin/
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /admin/
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "256Mi"
        # Cloudflared sidecar for DNS-over-HTTPS (bypasses UniFi DNS interception)
        - name: cloudflared
          image: cloudflare/cloudflared:latest
          args:
            - proxy-dns
            - --port=5053
            - --upstream=https://1.1.1.1/dns-query
            - --upstream=https://1.0.0.1/dns-query
          resources:
            limits:
              cpu: "100m"
              memory: "128Mi"
            requests:
              cpu: "50m"
              memory: "64Mi"
      volumes:
        - name: pihole-config-volume
          persistentVolumeClaim:
            claimName: pihole-config-pvc
        - name: dnsmasq-config-volume
          persistentVolumeClaim:
            claimName: pihole-dnsmasq-pvc
        - name: adlists
          configMap:
            name: pihole-adlists
        - name: dnsmasq-custom
          configMap:
            name: pihole-dnsmasq-custom
---
# DNS Service (LoadBalancer with specific IP)
apiVersion: v1
kind: Service
metadata:
  name: pihole-dns
  namespace: pihole
  annotations:
    metallb.universe.tf/loadBalancerIPs: "192.168.10.53"
    metallb.universe.tf/address-pool: "pihole-pool"
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: pihole
  ports:
    - name: dns-tcp
      port: 53
      targetPort: 53
      protocol: TCP
    - name: dns-udp
      port: 53
      targetPort: 53
      protocol: UDP
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: https
      port: 443
      targetPort: 443
      protocol: TCP
---
# Web UI Service (NodePort for admin access - kept as backup)
apiVersion: v1
kind: Service
metadata:
  name: pihole-web
  namespace: pihole
spec:
  type: NodePort
  selector:
    app: pihole
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
